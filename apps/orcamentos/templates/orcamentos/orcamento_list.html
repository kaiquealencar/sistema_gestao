{% extends "base.html" %}

{% block title %}Lista de Or√ßamentos{% endblock %}

{% block content %}
<h1>Lista de Or√ßamentos</h1>

<a href="{% url 'orcamentos:orcamento_create' %}"
   class="btn btn-primary mb-3">
    Novo Or√ßamento
</a>

<table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Data</th>
            <th>Validade</th>
            <th>Status</th>
            <th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody>
        {% for orcamento in orcamentos %}
        <tr>
            <td>{{ orcamento.id }}</td>
            <td>{{ orcamento.cliente.nome }}</td>
            <td>{{ orcamento.data_criacao|date:"d/m/Y" }}</td>
            <td>{{ orcamento.validade|date:"d/m/Y" }}</td>
            <td>
                <span class="badge bg-info text-dark">
                    {{ orcamento.get_status_display }}
                </span>
            </td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-info"
                        data-bs-toggle="modal"
                        data-bs-target="#orcamentoModal"
                        data-url="{% url 'orcamentos:orcamento_detail' orcamento.id %}">
                        Ver
                    </button>

                    <a href="{% url 'orcamentos:orcamento_edit' orcamento.id %}"
                       class="btn btn-sm btn-outline-warning">
                        Editar
                    </a>
                     <a href="{% url 'orcamentos:exportar_orcamento_pdf' orcamento.id %}"
                       class="btn btn-sm btn-outline-secondary" 
                       target="_blank"
                       title="Exportar para PDF">
                       <i class="bi bi-printer"></i>
                        Exportar PDF
                    </a>
                    <button type="button" 
                            onclick="enviarZap(this, '{% url 'orcamentos:enviar_orcamento_whatsapp' orcamento.id %}')"
                            class="btn btn-sm btn-outline-success">
                            <span>üì≤</span> Enviar Whatsapp
                    </button>

                    <button class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmDeleteModal"
                            data-name="Or√ßamento #{{ orcamento.id }}"
                            data-action="{% url 'orcamentos:orcamento_delete' orcamento.id %}">
                        Excluir
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
    <script>
        function enviarZap(btn, url) {
            const originalText = btn.innerHTML;
            
            // Feedback visual
            btn.disabled = true;
            btn.innerHTML = "‚åõ Enviando...";

            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(async response => {
                const data = await response.json(); // Tenta ler o JSON de resposta

                if (response.ok) {
                    alert("‚úÖ Or√ßamento enviado com sucesso!");
                } else {
                    // Se a View retornou erro (ex: n√∫mero inv√°lido na Twilio)
                    alert("‚ùå Erro: " + (data.message || "Erro desconhecido"));
                }
            })
            .catch(error => {
                alert("üö® Erro de conex√£o ou servidor.");
                console.error(error);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }
    </script>
{% endblock %}
